# MTG Collection Tracker
# Deploy on Raspberry Pi 4
#
# NOTE: This app is behind the central nginx proxy (Infra repo)
# No ports are exposed directly - traffic comes through nginx-proxy
#
# Structure on Pi:
#   ~/infra/           <- Central proxy (handles SSL & routing)
#   ~/MTG-Collection/  <- this repo
#
# Usage:
#   cd ~/MTG-Collection
#   docker compose up -d

services:
  # ============================================
  # DATABASE - PostgreSQL
  # ============================================
  db:
    image: postgres:15-alpine
    container_name: mtg-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: mtg
      POSTGRES_PASSWORD: ${DB_PASSWORD:-mtg_secret}
      POSTGRES_DB: mtg_collection
    volumes:
      - mtg_postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mtg -d mtg_collection"]
      interval: 10s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # BACKEND - Python Flask API
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mtg-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://mtg:${DB_PASSWORD:-mtg_secret}@db:5432/mtg_collection
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      PORT: 5000
      FRONTEND_URL: ${FRONTEND_URL:-https://mtg.francony.fr}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-credentials.json
    expose:
      - "5000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - mtg_uploads:/app/uploads
      - ./backend/google-credentials.json:/app/google-credentials.json:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # FRONTEND - React via Nginx (internal only)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # API URL - empty because nginx-proxy handles /api routing
        VITE_API_URL: ""
    container_name: mtg-frontend
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - backend

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mtg_postgres_data:
  mtg_uploads:

networks:
  default:
    name: mtg_network
    driver: bridge
