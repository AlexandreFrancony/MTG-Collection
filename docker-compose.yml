# MTG Collection Tracker
# Deploy on Raspberry Pi 4
#
# NOTE: This app is behind the central nginx proxy (Infra repo)
# No ports are exposed directly - traffic comes through nginx-proxy
# Database is hosted centrally in the Infra stack (postgres container)
#
# Structure on Pi:
#   ~/Hosting/Infra/           <- Central proxy + database
#   ~/Hosting/MTG-Collection/  <- this repo
#
# Usage:
#   cd ~/MTG-Collection
#   docker compose up -d

services:
  # ============================================
  # BACKEND - Python Flask API
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mtg-backend
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      DATABASE_URL: postgresql://mtg:${DB_PASSWORD:?DB_PASSWORD is required}@postgres:5432/mtg_collection
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      PORT: 5000
      FRONTEND_URL: ${FRONTEND_URL:-https://mtg.francony.fr}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-credentials.json
    expose:
      - "5000"
    volumes:
      - mtg_uploads:/app/uploads
      - /home/bloster/Hosting/MTG-Collection/backend/google-credentials.json:/app/google-credentials.json:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # FRONTEND - React via Nginx (internal only)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # API URL - empty because nginx-proxy handles /api routing
        VITE_API_URL: ""
    container_name: mtg-frontend
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    expose:
      - "80"
    depends_on:
      - backend

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mtg_uploads:

networks:
  default:
    name: mtg_network
    driver: bridge
